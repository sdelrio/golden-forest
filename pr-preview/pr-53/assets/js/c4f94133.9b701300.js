"use strict";(self.webpackChunkgolden_forest_website=self.webpackChunkgolden_forest_website||[]).push([["9575"],{65354:function(e,r,t){t.r(r),t.d(r,{frontMatter:()=>o,toc:()=>c,default:()=>d,metadata:()=>n,assets:()=>i,contentTitle:()=>l});var n=JSON.parse('{"id":"Infrastructure-and-Cloud/Cloud-Platform/Kubernetes/Concepts/hpa-autoscalers","title":"HPA autoscalers","description":"Autoscale using Prometheus","source":"@site/docs/Infrastructure-and-Cloud/Cloud-Platform/Kubernetes/Concepts/hpa-autoscalers.md","sourceDirName":"Infrastructure-and-Cloud/Cloud-Platform/Kubernetes/Concepts","slug":"/Infrastructure-and-Cloud/Cloud-Platform/Kubernetes/Concepts/hpa-autoscalers","permalink":"/pr-preview/pr-53/docs/Infrastructure-and-Cloud/Cloud-Platform/Kubernetes/Concepts/hpa-autoscalers","draft":false,"unlisted":false,"editUrl":"https://github.com/sdelrio/golden-forest/edit/master/docs/Infrastructure-and-Cloud/Cloud-Platform/Kubernetes/Concepts/hpa-autoscalers.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Horizontal Pod Autoscaler","permalink":"/pr-preview/pr-53/docs/Infrastructure-and-Cloud/Cloud-Platform/Kubernetes/Concepts/HPA"},"next":{"title":"k8s Network Policies","permalink":"/pr-preview/pr-53/docs/Infrastructure-and-Cloud/Cloud-Platform/Kubernetes/Concepts/k8s-network-policies"}}'),s=t(74848),a=t(84429);let o={},l="HPA autoscalers",i={},c=[{value:"Autoscale using Prometheus",id:"autoscale-using-prometheus",level:2},{value:"Architecture Overview",id:"architecture-overview",level:3},{value:"Requirements",id:"requirements",level:3},{value:"Deployment",id:"deployment",level:4},{value:"Prometheus Adapter",id:"prometheus-adapter",level:4},{value:"References",id:"references",level:3}];function u(e){let r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",mermaid:"mermaid",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"hpa-autoscalers",children:"HPA autoscalers"})}),"\n",(0,s.jsx)(r.h2,{id:"autoscale-using-prometheus",children:"Autoscale using Prometheus"}),"\n",(0,s.jsx)(r.h3,{id:"architecture-overview",children:"Architecture Overview"}),"\n",(0,s.jsx)(r.mermaid,{value:"\n  flowchart TB;\n\n    HPA --custom/metrics.k8s.io/v1beta1--\x3e CMAPI[Custom Metrics API]\n    CMAPI --\x3e Prometheus\n    Prometheus --/metrics--\x3e Pods\n\n    classDef red fill:#eaa,stroke:#c00,stroke-width:2px\n    classDef green fill:#beb,stroke:#ada,stroke-width:2px\n    classDef blue fill:#bbe,stroke:#aad,stroke-width:2px\n\n\n    class HPA red\n    class CMAPI green\n    class Prometheus green\n    class Pods blue\n"}),"\n",(0,s.jsx)(r.h3,{id:"requirements",children:"Requirements"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"External metrics provider (k8s 1.10+)"}),"\n",(0,s.jsx)(r.li,{children:"Prometheus"}),"\n",(0,s.jsx)(r.li,{children:"Prometheus adapter"}),"\n"]}),"\n",(0,s.jsx)(r.h4,{id:"deployment",children:"Deployment"}),"\n",(0,s.jsx)(r.p,{children:"Make sure Deployment gathers prometheus metrics:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:'  template:\n    metadata:\n      annotations:\n        prometheus.io/path: "/metrics"\n        prometheus.io/scrape: "true"\n        prometheus.io/port: "8000"\n'})}),"\n",(0,s.jsx)(r.h4,{id:"prometheus-adapter",children:"Prometheus Adapter"}),"\n",(0,s.jsxs)(r.p,{children:["Add a ",(0,s.jsx)(r.a,{href:"https://github.com/prometheus-community/helm-charts/blob/cd5c69a2ef0a3d5f3478374ba495d27a57b444d4/charts/prometheus-adapter/values.yaml#L85-L87",children:"custom rule"})," on prometheus or a Configmap for the adapter config and mount it as volume on the prometheus adapter deployment:"]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"configmap"}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: adapter-config\n  namespace: monitoring\ndata:\n  config.yaml: |\n    rules:\n    - seriesQuery: \'nginx_vts_server_requests_total\'\n      resources:\n        overrides:\n          kubernetes_namespace:\n            resource: namespace\n          kubernetes_pod_name:\n            resource: pod\n      name:\n        matches: "^(.*)_total"\n        as: "${1}_per_second"\n      metricsQuery: (sum(rate([<.Series>>{<<.LabelMatchers>>}[1m])) by (<<.GroupBy>](<.Series>>{<<.LabelMatchers>>}[1m])) by (<<.GroupBy>)))\n'})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"prometheus adapter deployment"}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"        volumeMounts:\n        - mountPath: /etc/adapter/\n          name: config\n          readOnly: true\n      volumes:\n      - name: config\n        configMap:\n          name: adapter-config\n"})}),"\n",(0,s.jsx)(r.h3,{id:"references",children:"References"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://pet2cattle.com/2022/04/prometheus-hpa-external-metrics",children:"https://pet2cattle.com/2022/04/prometheus-hpa-external-metrics"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://medium.com/the-metricfire-blog/prometheus-metrics-based-autoscaling-in-kubernetes-3f4388501c8e",children:"https://medium.com/the-metricfire-blog/prometheus-metrics-based-autoscaling-in-kubernetes-3f4388501c8e"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://www.metricfire.com/blog/prometheus-metrics-based-autoscaling-in-kubernetes/",children:"https://www.metricfire.com/blog/prometheus-metrics-based-autoscaling-in-kubernetes/"})}),"\n"]})]})}function d(e={}){let{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},84429:function(e,r,t){t.d(r,{R:()=>o,x:()=>l});var n=t(96540);let s={},a=n.createContext(s);function o(e){let r=n.useContext(a);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),n.createElement(a.Provider,{value:r},e.children)}}}]);