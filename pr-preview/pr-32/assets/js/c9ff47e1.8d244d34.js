"use strict";(self.webpackChunkgolden_forest_website=self.webpackChunkgolden_forest_website||[]).push([[750],{28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>l});var r=t(96540);const i={},s=r.createContext(i);function a(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(s.Provider,{value:n},e.children)}},36575:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"Containers/Docker/dockerfile-python","title":"Dockerfile for Python","description":"Since Docker 17.05 there is support for multistage builds. So the general idea is to make a stage for the builder and another stage for the runtime.","source":"@site/docs/Containers/Docker/dockerfile-python.md","sourceDirName":"Containers/Docker","slug":"/Containers/Docker/dockerfile-python","permalink":"/pr-preview/pr-32/docs/Containers/Docker/dockerfile-python","draft":false,"unlisted":false,"editUrl":"https://github.com/sdelrio/golden-forest/edit/master/docs/Containers/Docker/dockerfile-python.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Dockerfile for node.js","permalink":"/pr-preview/pr-32/docs/Containers/Docker/dockerfile-node"},"next":{"title":"Container Registry","permalink":"/pr-preview/pr-32/docs/Containers/container-registry"}}');var i=t(74848),s=t(28453),a=t(65537),l=t(79329);const o={},c="Dockerfile for Python",u={},d=[{value:"Logs",id:"logs",level:2},{value:"Alpine base image",id:"alpine-base-image",level:2},{value:"Multistage build",id:"multistage-build",level:4},{value:"Smallest size python base image",id:"smallest-size-python-base-image",level:3},{value:"Small size with wheel usage",id:"small-size-with-wheel-usage",level:2},{value:"Nuitka",id:"nuitka",level:2},{value:"References",id:"references",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"dockerfile-for-python",children:"Dockerfile for Python"})}),"\n",(0,i.jsxs)(n.p,{children:["Since Docker 17.05 there is support for ",(0,i.jsx)(n.a,{href:"https://docs.docker.com/develop/develop-images/multistage-build",children:"multistage builds"}),". So the general idea is to make a stage for the builder and another stage for the runtime."]}),"\n",(0,i.jsx)(n.h2,{id:"logs",children:"Logs"}),"\n",(0,i.jsx)(n.p,{children:"By default, if we put python into a container we can get slow docker logs or not refreshing in real time. To fix this we can disable buffer logs, since this will be managed by the container runtime."}),"\n","\n",(0,i.jsxs)(a.A,{children:[(0,i.jsx)(l.A,{value:"env",label:"Using ENV",default:!0,children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"export PYTHONUNBUFFERED=1\n"})})}),(0,i.jsx)(l.A,{value:"cli",label:"Command line option",children:(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'CMD ["python","-u","main.py"]\n'})})})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://stackoverflow.com/questions/29663459/python-app-does-not-print-anything-when-running-detached-in-docker",children:"https://stackoverflow.com/questions/29663459/python-app-does-not-print-anything-when-running-detached-in-docker"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://stackoverflow.com/questions/107705/disable-output-buffering",children:"https://stackoverflow.com/questions/107705/disable-output-buffering"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"alpine-base-image",children:"Alpine base image"}),"\n",(0,i.jsxs)(n.p,{children:["You will get small image sizes, but has some drawback, like using ",(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Musl",children:"musl"})," libs and ",(0,i.jsx)(n.a,{href:"https://pythonwheels.com/",children:"wheels"})," package sometimes are not available so you must compile packages when building image, but as a result you can get longer build times, some strange bugs or even performance issues. So it's better to use the official ubuntu images, you will get faster builds, standard libs and security maintenance updates."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://pythonspeed.com/articles/base-image-python-docker-images/",children:"2021: The best Docker base image for your Python application"})}),"\n",(0,i.jsx)(n.h4,{id:"multistage-build",children:"Multistage build"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'FROM python:3.7-alpine as base\n\nFROM base as builder\n\nRUN mkdir /install\nWORKDIR /install\n\nCOPY requirements.txt /requirements.txt\n\nRUN pip install --install-option="--prefix=/install" -r /requirements.txt\n\nFROM base\n\nCOPY --from=builder /install /usr/local\nCOPY src /app\n\nWORKDIR /app\n\nCMD ["gunicorn", "-w 4", "main:app"]\n'})}),"\n",(0,i.jsx)(n.h3,{id:"smallest-size-python-base-image",children:"Smallest size python base image"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'FROM alpine:3.14\n\n# This hack is widely applied to avoid python printing issues in docker containers.\n# See: https://github.com/Docker-Hub-frolvlad/docker-alpine-python3/pull/13\nENV PYTHONUNBUFFERED=1\n\nRUN echo "**** install Python ****" && \\\n    apk add --no-cache python3 && \\\n    if [ ! -e /usr/bin/python ]; then ln -sf python3 /usr/bin/python ; fi && \\\n    \\\n    echo "**** install pip ****" && \\\n    python3 -m ensurepip && \\\n    rm -r /usr/lib/python*/ensurepip && \\\n    pip3 install --no-cache --upgrade pip setuptools wheel && \\\n    if [ ! -e /usr/bin/pip ]; then ln -s pip3 /usr/bin/pip ; fi\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/Docker-Hub-frolvlad/docker-alpine-python3",children:"https://github.com/Docker-Hub-frolvlad/docker-alpine-python3"})}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"small-size-with-wheel-usage",children:"Small size with wheel usage"}),"\n",(0,i.jsxs)(n.p,{children:["Using ",(0,i.jsx)(n.code,{children:"pip wheel"}),", and a few more best practices sprinkled in, here\u2019s a sample of multi-stage ",(0,i.jsx)(n.code,{children:"Dockerfile"})," looks like:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# build stage\n# ========================\nFROM python:3.8.0 as build\nENV DOCKER_STAGE=build PYTHONUNBUFFERED=1\n\nRUN \\\n  DEBIAN_FRONTEND=noninteractive apt-get update \\\n  && DEBIAN_FRONTEND=noninteractive apt-get -y install \\\n      --no-install-recommends \\\n      build-deps=1.7.* \\\n      build-tools=2.*\n\nWORKDIR /build\n\nRUN \\\n  pip --no-cache-dir install \\\n    --upgrade \\\n    pip \\\n    setuptools \\\n    wheel\n\nCOPY src/requirements.txt .\n\nRUN \\\n  pip wheel \\\n    --wheel-dir /wheels \\\n    --find-links /wheels \\\n    -r requirements.txt\n\nCOPY src/ .\n\nRUN \\\n  pip wheel \\\n    --wheel-dir /wheels \\\n    --find-links /wheels \\\n    --no-index \\\n    .\n\n# run stage\n# ===========================\nFROM python:3.8.0-slim as run\nENV DOCKER_STAGE=run PYTHONUNBUFFERED=1\n\nRUN \\\n  DEBIAN_FRONTEND=noninteractive apt-get update \\\n  && DEBIAN_FRONTEND=noninteractive apt-get -y install \\\n    --no-install-recommends \\\n    runtime-deps=8.3.* \\\n    runtime-tools=5.*\n\nCOPY --from=build /wheels /wheels\n\nRUN \\\n  pip --no-cache-dir install \\\n    --find-links /wheels \\\n    --no-index \\\n    my.app\n\nCMD ["python", "-m", "my.app.run"]\n'})}),"\n",(0,i.jsx)(n.h2,{id:"nuitka",children:"Nuitka"}),"\n",(0,i.jsx)(n.p,{children:"Minimal docker image containing a compiled python program and it's dependent libs"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'FROM transactcharlie/docker-nuitka:latest as builder\n\n## copy code and scripts\nCOPY examples/hello_world /app\nCOPY build_scripts /build_scripts\n\n## Install requirements\nRUN pip3 install -r app/requirements.txt\n\n## Execute nuitka\nRUN nuitka3 --standalone --show-progress --python-flag=no_site app/app.py\n\n## run build scripts\nRUN build_scripts/ldd_cp.sh "app.dist/app.exe" "app.dist"\nRUN ls -lhR app.dist\n\n##\xa0runtime stage\nFROM scratch\nLABEL org.label-schema.name="Hello World Example" \\\n      org.label-schema.vcs-url="https://github.com/TransactCharlie/nuitka-docker-example" \\\n      org.label-schema.description="Full example App compiled with nuitka in a scratch docker container"\nCOPY --from=builder /app.dist/ /\nCMD ["/app.exe"]\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/TransactCharlie/nuitka-docker-example/blob/master/build_scripts/ldd_cp.sh",children:"2018: GitHub"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/TransactCharlie/nuitka-docker-example/blob/master/build_scripts/ldd_cp.shkkk",children:"Build script"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://medium.com/@ethan.edwards/building-tiny-python-docker-images-b029b194171d",children:"2019: Building Tiny Python Docker Images"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://blog.realkinetic.com/building-minimal-docker-containers-for-python-applications-37d0272c52f3?gi=33012cf6d374",children:"2018: Building Minimal Docker Containers for Python Applications"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://blog.hasura.io/how-to-write-dockerfiles-for-python-web-apps-6d173842ae1d/",children:"2018: How to Write Dockerfiles for Python Web Apps"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://simonwillison.net/2018/Nov/19/smaller-python-docker-images/",children:"2018: Building smaller Python Docker images"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}},65537:(e,n,t)=>{t.d(n,{A:()=>w});var r=t(96540),i=t(34164),s=t(65627),a=t(56347),l=t(50372),o=t(30604),c=t(11861),u=t(78749);function d(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function p(e){const{values:n,children:t}=e;return(0,r.useMemo)((()=>{const e=n??function(e){return d(e).map((e=>{let{props:{value:n,label:t,attributes:r,default:i}}=e;return{value:n,label:t,attributes:r,default:i}}))}(t);return function(e){const n=(0,c.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,t])}function h(e){let{value:n,tabValues:t}=e;return t.some((e=>e.value===n))}function m(e){let{queryString:n=!1,groupId:t}=e;const i=(0,a.W6)(),s=function(e){let{queryString:n=!1,groupId:t}=e;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!t)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:n,groupId:t});return[(0,o.aZ)(s),(0,r.useCallback)((e=>{if(!s)return;const n=new URLSearchParams(i.location.search);n.set(s,e),i.replace({...i.location,search:n.toString()})}),[s,i])]}function b(e){const{defaultValue:n,queryString:t=!1,groupId:i}=e,s=p(e),[a,o]=(0,r.useState)((()=>function(e){let{defaultValue:n,tabValues:t}=e;if(0===t.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!h({value:n,tabValues:t}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${n}" but none of its children has the corresponding value. Available values are: ${t.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return n}const r=t.find((e=>e.default))??t[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:n,tabValues:s}))),[c,d]=m({queryString:t,groupId:i}),[b,f]=function(e){let{groupId:n}=e;const t=function(e){return e?`docusaurus.tab.${e}`:null}(n),[i,s]=(0,u.Dv)(t);return[i,(0,r.useCallback)((e=>{t&&s.set(e)}),[t,s])]}({groupId:i}),g=(()=>{const e=c??b;return h({value:e,tabValues:s})?e:null})();(0,l.A)((()=>{g&&o(g)}),[g]);return{selectedValue:a,selectValue:(0,r.useCallback)((e=>{if(!h({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);o(e),d(e),f(e)}),[d,f,s]),tabValues:s}}var f=t(9136);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var k=t(74848);function x(e){let{className:n,block:t,selectedValue:r,selectValue:a,tabValues:l}=e;const o=[],{blockElementScrollPositionUntilNextRender:c}=(0,s.a_)(),u=e=>{const n=e.currentTarget,t=o.indexOf(n),i=l[t].value;i!==r&&(c(n),a(i))},d=e=>{let n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{const t=o.indexOf(e.currentTarget)+1;n=o[t]??o[0];break}case"ArrowLeft":{const t=o.indexOf(e.currentTarget)-1;n=o[t]??o[o.length-1];break}}n?.focus()};return(0,k.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":t},n),children:l.map((e=>{let{value:n,label:t,attributes:s}=e;return(0,k.jsx)("li",{role:"tab",tabIndex:r===n?0:-1,"aria-selected":r===n,ref:e=>{o.push(e)},onKeyDown:d,onClick:u,...s,className:(0,i.A)("tabs__item",g.tabItem,s?.className,{"tabs__item--active":r===n}),children:t??n},n)}))})}function y(e){let{lazy:n,children:t,selectedValue:s}=e;const a=(Array.isArray(t)?t:[t]).filter(Boolean);if(n){const e=a.find((e=>e.props.value===s));return e?(0,r.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,k.jsx)("div",{className:"margin-top--md",children:a.map(((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==s})))})}function v(e){const n=b(e);return(0,k.jsxs)("div",{className:(0,i.A)("tabs-container",g.tabList),children:[(0,k.jsx)(x,{...n,...e}),(0,k.jsx)(y,{...n,...e})]})}function w(e){const n=(0,f.A)();return(0,k.jsx)(v,{...e,children:d(e.children)},String(n))}},79329:(e,n,t)=>{t.d(n,{A:()=>a});t(96540);var r=t(34164);const i={tabItem:"tabItem_Ymn6"};var s=t(74848);function a(e){let{children:n,hidden:t,className:a}=e;return(0,s.jsx)("div",{role:"tabpanel",className:(0,r.A)(i.tabItem,a),hidden:t,children:n})}}}]);