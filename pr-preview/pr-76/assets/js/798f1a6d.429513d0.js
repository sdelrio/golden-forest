"use strict";(self.webpackChunkgolden_forest_website=self.webpackChunkgolden_forest_website||[]).push([["7742"],{77154:function(e,n,i){i.r(n),i.d(n,{frontMatter:()=>o,toc:()=>u,default:()=>p,metadata:()=>r,assets:()=>c,contentTitle:()=>d});var r=JSON.parse('{"id":"Infrastructure-and-Cloud/Containers/Docker/dockerfile-python","title":"Python Dockerfiles","description":"Since version 17.05, Docker has supported multi-stage builds, which allow for the separation of build-time dependencies from the final runtime image. This approach optimizes image size and enhances security by excluding unnecessary tools from the production environment.","source":"@site/docs/Infrastructure-and-Cloud/Containers/Docker/dockerfile-python.md","sourceDirName":"Infrastructure-and-Cloud/Containers/Docker","slug":"/Infrastructure-and-Cloud/Containers/Docker/dockerfile-python","permalink":"/pr-preview/pr-76/docs/Infrastructure-and-Cloud/Containers/Docker/dockerfile-python","draft":false,"unlisted":false,"editUrl":"https://github.com/sdelrio/golden-forest/edit/master/docs/Infrastructure-and-Cloud/Containers/Docker/dockerfile-python.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Dockerfile for node.js","permalink":"/pr-preview/pr-76/docs/Infrastructure-and-Cloud/Containers/Docker/dockerfile-node"},"next":{"title":"Container Registry","permalink":"/pr-preview/pr-76/docs/Infrastructure-and-Cloud/Containers/container-registry"}}'),t=i(74848),a=i(84429),s=i(84109),l=i(93703);let o={},d="Python Dockerfiles",c={},u=[{value:"Log Buffering",id:"log-buffering",level:2},{value:"Alpine Base Image",id:"alpine-base-image",level:2},{value:"Hardened Base image",id:"hardened-base-image",level:2},{value:"Multistage build",id:"multistage-build",level:2},{value:"Smallest size python base image",id:"smallest-size-python-base-image",level:2},{value:"Small size with wheel usage",id:"small-size-with-wheel-usage",level:2},{value:"Nuitka",id:"nuitka",level:2},{value:"The .dockerignore file",id:"the-dockerignore-file",level:2},{value:"References",id:"references",level:2}];function h(e){let n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"python-dockerfiles",children:"Python Dockerfiles"})}),"\n",(0,t.jsxs)(n.p,{children:["Since version 17.05, Docker has supported ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/develop/develop-images/multistage-build",children:"multi-stage builds"}),", which allow for the separation of build-time dependencies from the final runtime image. This approach optimizes image size and enhances security by excluding unnecessary tools from the production environment."]}),"\n",(0,t.jsx)(n.h2,{id:"log-buffering",children:"Log Buffering"}),"\n",(0,t.jsx)(n.p,{children:"By default, Python buffers its output, which can cause delays in log visibility when running within a container. To ensure that logs are emitted in real-time and managed correctly by the container runtime, you should disable output buffering."}),"\n","\n",(0,t.jsxs)(s.A,{children:[(0,t.jsx)(l.A,{value:"env",label:"Using ENV",default:!0,children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"export PYTHONUNBUFFERED=1\n"})})}),(0,t.jsx)(l.A,{value:"cli",label:"Command line option",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'CMD ["python","-u","main.py"]\n'})})})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://stackoverflow.com/questions/29663459/python-app-does-not-print-anything-when-running-detached-in-docker",children:"https://stackoverflow.com/questions/29663459/python-app-does-not-print-anything-when-running-detached-in-docker"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://stackoverflow.com/questions/107705/disable-output-buffering",children:"https://stackoverflow.com/questions/107705/disable-output-buffering"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"alpine-base-image",children:"Alpine Base Image"}),"\n",(0,t.jsx)(n.p,{children:"While Alpine-based images offer a smaller footprint, they introduce several trade-offs:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Library Compatibility"}),": Alpine uses ",(0,t.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Musl",children:"musl"})," instead of ",(0,t.jsx)(n.code,{children:"glibc"}),". This can lead to subtle bugs or performance degradation in applications expecting standard C libraries."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Extended Build Times"}),": Pre-compiled ",(0,t.jsx)(n.a,{href:"https://pythonwheels.com/",children:"wheels"})," are often unavailable for Alpine. This requires compiling packages from source during the build process, which significantly increases build duration."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Stability"}),": Official Debian or Ubuntu-based images are generally recommended for production environments to ensure faster builds, standard library compatibility, and consistent security maintenance."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["For more information, see: ",(0,t.jsx)(n.a,{href:"https://pythonspeed.com/articles/base-image-python-docker-images/",children:"The best Docker base image for your Python application"})]}),"\n",(0,t.jsx)(n.h2,{id:"hardened-base-image",children:"Hardened Base image"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://www.docker.com/products/hardened-images/",children:"docker hardened images"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://hub.docker.com/hardened-images/catalog/dhi/python",children:"dhi python hardened images"})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Docker Hardened Images come in different variants depending on their intended use."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Runtime variants are designed to run your application in production. These images are intended to be used either directly or as the ",(0,t.jsx)(n.code,{children:"FROM"})," image in the final stage of a multi-stage build. These images typically:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Run as the nonroot user"}),"\n",(0,t.jsx)(n.li,{children:"Do not include a shell or a package manager"}),"\n",(0,t.jsx)(n.li,{children:"Contain only the minimal set of libraries needed to run the app"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["Build-time variants typically include dev in the variant name and are intended for use in the first stage of a multi-stage Dockerfile. These images typically:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Run as the root user"}),"\n",(0,t.jsx)(n.li,{children:"Include a shell and package manager"}),"\n",(0,t.jsx)(n.li,{children:"Are used to build or compile applications"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["FIPS variants","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Include fips in the variant name and tag."}),"\n",(0,t.jsx)(n.li,{children:"They come in both runtime and build-time variants."}),"\n",(0,t.jsx)(n.li,{children:"These variants use cryptographic modules that have been validated under FIPS 140, a U.S. government standard for secure cryptographic operations."}),"\n",(0,t.jsx)(n.li,{children:"Docker Hardened Python images include FIPS-compliant variants for environments requiring Federal Information Processing Standards compliance."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:'# syntax=docker/dockerfile:1\n\n## -----------------------------------------------------\n## Build stage (use tag with -dev suffix: e.g. 3.9.23-debian13-fips-dev)\nFROM dhi.io/python:<tag> AS build-stage\n\nENV PYTHONDONTWRITEBYTECODE=1\nENV PYTHONUNBUFFERED=1\nENV PATH="/app/venv/bin:$PATH"\n\nWORKDIR /app\n\nRUN python -m venv /app/venv\nCOPY requirements.txt .\nRUN pip install --no-cache-dir -r requirements.txt\n\n## -----------------------------------------------------\n## Final stage (use the same tag as above but without the -dev suffix e.g. 3.9.23-debian13-fips)\nFROM dhi.io/python:<tag> AS runtime-stage\n\nENV PYTHONDONTWRITEBYTECODE=1\nENV PYTHONUNBUFFERED=1\nENV PATH="/app/venv/bin:$PATH"\n\nWORKDIR /app\n\nCOPY --from=build-stage /app/venv /app/venv\nCOPY app.py .\n\nCMD ["python", "/app/app.py"]\n'})}),"\n",(0,t.jsx)(n.h2,{id:"multistage-build",children:"Multistage build"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Build stage with dependencies"}),"\n",(0,t.jsx)(n.li,{children:"Production stage with only required runtime file dependencies"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:'FROM python:3.7-alpine as base\n\nFROM base as builder\n\nRUN mkdir /install\nWORKDIR /install\n\nCOPY requirements.txt /requirements.txt\n\nRUN pip install --install-option="--prefix=/install" -r /requirements.txt\n\nFROM base\n\nCOPY --from=builder /install /usr/local\nCOPY src /app\n\nWORKDIR /app\n\nCMD ["gunicorn", "-w 4", "main:app"]\n'})}),"\n",(0,t.jsx)(n.h2,{id:"smallest-size-python-base-image",children:"Smallest size python base image"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:'FROM alpine:3.14\n\n# This hack is widely applied to avoid python printing issues in docker containers.\n# See: https://github.com/Docker-Hub-frolvlad/docker-alpine-python3/pull/13\nENV PYTHONUNBUFFERED=1\n\nRUN echo "**** install Python ****" && \\\n    apk add --no-cache python3 && \\\n    if [ ! -e /usr/bin/python ]; then ln -sf python3 /usr/bin/python ; fi && \\\n    \\\n    echo "**** install pip ****" && \\\n    python3 -m ensurepip && \\\n    rm -r /usr/lib/python*/ensurepip && \\\n    pip3 install --no-cache --upgrade pip setuptools wheel && \\\n    if [ ! -e /usr/bin/pip ]; then ln -s pip3 /usr/bin/pip ; fi\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/Docker-Hub-frolvlad/docker-alpine-python3",children:"https://github.com/Docker-Hub-frolvlad/docker-alpine-python3"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"small-size-with-wheel-usage",children:"Small size with wheel usage"}),"\n",(0,t.jsxs)(n.p,{children:["Using ",(0,t.jsx)(n.code,{children:"pip wheel"}),", and a few more best practices sprinkled in, here\u2019s a sample of multi-stage ",(0,t.jsx)(n.code,{children:"Dockerfile"})," looks like:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:'# build stage\n# ========================\nFROM python:3.8.0 as build\nENV DOCKER_STAGE=build PYTHONUNBUFFERED=1\n\nRUN \\\n  DEBIAN_FRONTEND=noninteractive apt-get update \\\n  && DEBIAN_FRONTEND=noninteractive apt-get -y install \\\n      --no-install-recommends \\\n      build-deps=1.7.* \\\n      build-tools=2.*\n\nWORKDIR /build\n\nRUN \\\n  pip --no-cache-dir install \\\n    --upgrade \\\n    pip \\\n    setuptools \\\n    wheel\n\nCOPY src/requirements.txt .\n\nRUN \\\n  pip wheel \\\n    --wheel-dir /wheels \\\n    --find-links /wheels \\\n    -r requirements.txt\n\nCOPY src/ .\n\nRUN \\\n  pip wheel \\\n    --wheel-dir /wheels \\\n    --find-links /wheels \\\n    --no-index \\\n    .\n\n# run stage\n# ===========================\nFROM python:3.8.0-slim as run\nENV DOCKER_STAGE=run PYTHONUNBUFFERED=1\n\nRUN \\\n  DEBIAN_FRONTEND=noninteractive apt-get update \\\n  && DEBIAN_FRONTEND=noninteractive apt-get -y install \\\n    --no-install-recommends \\\n    runtime-deps=8.3.* \\\n    runtime-tools=5.*\n\nCOPY --from=build /wheels /wheels\n\nRUN \\\n  pip --no-cache-dir install \\\n    --find-links /wheels \\\n    --no-index \\\n    my.app\n\nCMD ["python", "-m", "my.app.run"]\n'})}),"\n",(0,t.jsx)(n.h2,{id:"nuitka",children:"Nuitka"}),"\n",(0,t.jsx)(n.p,{children:"Minimal docker image containing a compiled python program and it's dependent libs"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:'FROM transactcharlie/docker-nuitka:latest as builder\n\n## copy code and scripts\nCOPY examples/hello_world /app\nCOPY build_scripts /build_scripts\n\n## Install requirements\nRUN pip3 install -r app/requirements.txt\n\n## Execute nuitka\nRUN nuitka3 --standalone --show-progress --python-flag=no_site app/app.py\n\n## run build scripts\nRUN build_scripts/ldd_cp.sh "app.dist/app.exe" "app.dist"\nRUN ls -lhR app.dist\n\n##\xa0runtime stage\nFROM scratch\nLABEL org.label-schema.name="Hello World Example" \\\n      org.label-schema.vcs-url="https://github.com/TransactCharlie/nuitka-docker-example" \\\n      org.label-schema.description="Full example App compiled with nuitka in a scratch docker container"\nCOPY --from=builder /app.dist/ /\nCMD ["/app.exe"]\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/TransactCharlie/nuitka-docker-example/blob/master/build_scripts/ldd_cp.sh",children:"Nuitka Docker Example"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/TransactCharlie/nuitka-docker-example/blob/master/build_scripts/ldd_cp.shkkk",children:"Build script"})}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"the-dockerignore-file",children:"The .dockerignore file"}),"\n",(0,t.jsxs)(n.p,{children:["A ",(0,t.jsx)(n.code,{children:".dockerignore"})," file optimizes the Docker build process by excluding unnecessary files from the build context:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Exclude artifacts"}),": Remove virtual environments (",(0,t.jsx)(n.code,{children:"venv"}),"), Python cache (",(0,t.jsx)(n.code,{children:"__pycache__"}),"), and temporary files."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Reduce build context"}),": Minimizing the data sent to the Docker daemon improves build performance and security."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://medium.com/@ethan.edwards/building-tiny-python-docker-images-b029b194171d",children:"2019: Building Tiny Python Docker Images"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://blog.realkinetic.com/building-minimal-docker-containers-for-python-applications-37d0272c52f3?gi=33012cf6d374",children:"2018: Building Minimal Docker Containers for Python Applications"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://blog.hasura.io/how-to-write-dockerfiles-for-python-web-apps-6d173842ae1d/",children:"2018: How to Write Dockerfiles for Python Web Apps"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://simonwillison.net/2018/Nov/19/smaller-python-docker-images/",children:"2018: Building smaller Python Docker images"})}),"\n"]})]})}function p(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},93703:function(e,n,i){i.d(n,{A:()=>a});var r=i(74848);i(96540);var t=i(39836);function a({children:e,hidden:n,className:i}){return(0,r.jsx)("div",{role:"tabpanel",className:(0,t.A)("tabItem_Ymn6",i),hidden:n,children:e})}},84109:function(e,n,i){i.d(n,{A:()=>y});var r=i(74848),t=i(96540),a=i(39836),s=i(16364),l=i(68251),o=i(56347),d=i(28004),c=i(25580),u=i(12213),h=i(75734);function p(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){let{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function m({value:e,tabValues:n}){return n.some(n=>n.value===e)}var f=i(98864);function g({className:e,block:n,selectedValue:i,selectValue:t,tabValues:s}){let o=[],{blockElementScrollPositionUntilNextRender:d}=(0,l.a_)(),c=e=>{let n=e.currentTarget,r=s[o.indexOf(n)].value;r!==i&&(d(n),t(r))},u=e=>{let n=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{let i=o.indexOf(e.currentTarget)+1;n=o[i]??o[0];break}case"ArrowLeft":{let i=o.indexOf(e.currentTarget)-1;n=o[i]??o[o.length-1]}}n?.focus()};return(0,r.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.A)("tabs",{"tabs--block":n},e),children:s.map(({value:e,label:n,attributes:t})=>(0,r.jsx)("li",{role:"tab",tabIndex:i===e?0:-1,"aria-selected":i===e,ref:e=>{o.push(e)},onKeyDown:u,onClick:c,...t,className:(0,a.A)("tabs__item","tabItem_LNqP",t?.className,{"tabs__item--active":i===e}),children:n??e},e))})}function b({lazy:e,children:n,selectedValue:i}){let s=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){let e=s.find(e=>e.props.value===i);return e?(0,t.cloneElement)(e,{className:(0,a.A)("margin-top--md",e.props.className)}):null}return(0,r.jsx)("div",{className:"margin-top--md",children:s.map((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==i}))})}function x(e){let n=function(e){let n,{defaultValue:i,queryString:r=!1,groupId:a}=e,s=function(e){let{values:n,children:i}=e;return(0,t.useMemo)(()=>{let e=n??p(i).map(({props:{value:e,label:n,attributes:i,default:r}})=>({value:e,label:n,attributes:i,default:r})),r=(0,u.XI)(e,(e,n)=>e.value===n.value);if(r.length>0)throw Error(`Docusaurus error: Duplicate values "${r.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[n,i])}(e),[l,f]=(0,t.useState)(()=>(function({defaultValue:e,tabValues:n}){if(0===n.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:n}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let i=n.find(e=>e.default)??n[0];if(!i)throw Error("Unexpected error: 0 tabValues");return i.value})({defaultValue:i,tabValues:s})),[g,b]=function({queryString:e=!1,groupId:n}){let i=(0,o.W6)(),r=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,c.aZ)(r),(0,t.useCallback)(e=>{if(!r)return;let n=new URLSearchParams(i.location.search);n.set(r,e),i.replace({...i.location,search:n.toString()})},[r,i])]}({queryString:r,groupId:a}),[x,y]=function({groupId:e}){let n=e?`docusaurus.tab.${e}`:null,[i,r]=(0,h.Dv)(n);return[i,(0,t.useCallback)(e=>{n&&r.set(e)},[n,r])]}({groupId:a}),v=m({value:n=g??x,tabValues:s})?n:null;return(0,d.A)(()=>{v&&f(v)},[v]),{selectedValue:l,selectValue:(0,t.useCallback)(e=>{if(!m({value:e,tabValues:s}))throw Error(`Can't select invalid tab value=${e}`);f(e),b(e),y(e)},[b,y,s]),tabValues:s}}(e);return(0,r.jsxs)("div",{className:(0,a.A)(s.G.tabs.container,"tabs-container","tabList__CuJ"),children:[(0,r.jsx)(g,{...n,...e}),(0,r.jsx)(b,{...n,...e})]})}function y(e){let n=(0,f.A)();return(0,r.jsx)(x,{...e,children:p(e.children)},String(n))}},84429:function(e,n,i){i.d(n,{R:()=>s,x:()=>l});var r=i(96540);let t={},a=r.createContext(t);function s(e){let n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);