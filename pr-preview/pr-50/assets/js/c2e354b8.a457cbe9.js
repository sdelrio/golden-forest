"use strict";(self.webpackChunkgolden_forest_website=self.webpackChunkgolden_forest_website||[]).push([["6662"],{63022:function(e,t,c){c.r(t),c.d(t,{frontMatter:()=>s,toc:()=>d,default:()=>u,metadata:()=>n,assets:()=>l,contentTitle:()=>i});var n=JSON.parse('{"id":"Cloud-Platform/Kubernetes/k8s-backup","title":"K8s backup","description":"Control Plane","source":"@site/docs/Cloud-Platform/Kubernetes/k8s-backup.md","sourceDirName":"Cloud-Platform/Kubernetes","slug":"/Cloud-Platform/Kubernetes/k8s-backup","permalink":"/pr-preview/pr-50/docs/Cloud-Platform/Kubernetes/k8s-backup","draft":false,"unlisted":false,"editUrl":"https://github.com/sdelrio/golden-forest/edit/master/docs/Cloud-Platform/Kubernetes/k8s-backup.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"K8s autoscalers","permalink":"/pr-preview/pr-50/docs/Cloud-Platform/Kubernetes/k8s-autoscalers"},"next":{"title":"kubectl usefull commands","permalink":"/pr-preview/pr-50/docs/Cloud-Platform/Kubernetes/k8s-cli-quick-guide"}}'),r=c(74848),a=c(84429);let s={},i="K8s backup",l={},d=[{value:"Control Plane",id:"control-plane",level:2},{value:"Relevant Certificates",id:"relevant-certificates",level:3},{value:"Backup certificates",id:"backup-certificates",level:4},{value:"Restore certificates",id:"restore-certificates",level:4},{value:"ETCD",id:"etcd",level:3},{value:"Make etcd snapshot",id:"make-etcd-snapshot",level:4},{value:"Restore etcd",id:"restore-etcd",level:4},{value:"kubeadm-config",id:"kubeadm-config",level:3},{value:"Backup kuebadm-config",id:"backup-kuebadm-config",level:4},{value:"Restore kuebadm-config",id:"restore-kuebadm-config",level:4},{value:"Initialize the master with the backup",id:"initialize-the-master-with-the-backup",level:4},{value:"References",id:"references",level:2}];function o(e){let t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"k8s-backup",children:"K8s backup"})}),"\n",(0,r.jsx)(t.h2,{id:"control-plane",children:"Control Plane"}),"\n",(0,r.jsx)(t.h3,{id:"relevant-certificates",children:"Relevant Certificates"}),"\n",(0,r.jsx)(t.h4,{id:"backup-certificates",children:"Backup certificates"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"sudo cp -r /etc/kubernetes/pki backup/\n"})}),"\n",(0,r.jsx)(t.h4,{id:"restore-certificates",children:"Restore certificates"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"sudo cp -r backup/pki /etc/kubernetes/\n"})}),"\n",(0,r.jsx)(t.h3,{id:"etcd",children:"ETCD"}),"\n",(0,r.jsx)(t.h4,{id:"make-etcd-snapshot",children:"Make etcd snapshot"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"sudo docker run --rm -v $(pwd)/backup:/backup \\\n    --network host \\\n    -v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd \\\n    --env ETCDCTL_API=3 \\\n    k8s.gcr.io/etcd:3.4.3-0 \\\n    etcdctl --endpoints=https://127.0.0.1:2379 \\\n    --cacert=/etc/kubernetes/pki/etcd/ca.crt \\\n    --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt \\\n    --key=/etc/kubernetes/pki/etcd/healthcheck-client.key \\\n    snapshot save /backup/etcd-snapshot-latest.db\n"})}),"\n",(0,r.jsx)(t.h4,{id:"restore-etcd",children:"Restore etcd"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"sudo mkdir -p /var/lib/etcd\nsudo docker run --rm \\\n    -v $(pwd)/backup:/backup \\\n    -v /var/lib/etcd:/var/lib/etcd \\\n    --env ETCDCTL_API=3 \\\n    k8s.gcr.io/etcd:3.4.3-0 \\\n    /bin/sh -c \"etcdctl snapshot restore '/backup/etcd-snapshot-latest.db' ; mv /default.etcd/member/ /var/lib/etcd/\"\n"})}),"\n",(0,r.jsx)(t.h3,{id:"kubeadm-config",children:"kubeadm-config"}),"\n",(0,r.jsx)(t.h4,{id:"backup-kuebadm-config",children:"Backup kuebadm-config"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"sudo cp /etc/kubeadm/kubeadm-config.yaml backup/\n"})}),"\n",(0,r.jsx)(t.h4,{id:"restore-kuebadm-config",children:"Restore kuebadm-config"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"sudo mkdir /etc/kubeadm\nsudo cp backup/kubeadm-config.yaml /etc/kubeadm/\n"})}),"\n",(0,r.jsx)(t.h4,{id:"initialize-the-master-with-the-backup",children:"Initialize the master with the backup"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"sudo kubeadm init --ignore-preflight-errors=DirAvailable--var-lib-etcd \\\n    --config /etc/kubeadm/kubeadm-config.yaml\n"})}),"\n",(0,r.jsx)(t.h2,{id:"references",children:"References"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:(0,r.jsx)(t.a,{href:"https://elastisys.com/backup-kubernetes-how-and-why/",children:"https://elastisys.com/backup-kubernetes-how-and-why/"})}),"\n"]})]})}function u(e={}){let{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},84429:function(e,t,c){c.d(t,{R:()=>s,x:()=>i});var n=c(96540);let r={},a=n.createContext(r);function s(e){let t=n.useContext(a);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),n.createElement(a.Provider,{value:t},e.children)}}}]);