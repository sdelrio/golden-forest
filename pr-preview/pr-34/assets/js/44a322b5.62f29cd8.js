"use strict";(self.webpackChunkgolden_forest_website=self.webpackChunkgolden_forest_website||[]).push([["3323"],{89943:function(e,n,r){r.r(n),r.d(n,{default:()=>h,frontMatter:()=>a,metadata:()=>i,assets:()=>o,toc:()=>c,contentTitle:()=>l});var i=JSON.parse('{"id":"DevOps/Infra as Code/terraform","title":"Terraform","description":"Terraform is an infrastructure as code (IaC) tool that allows you to build, change, and version infrastructure safely and efficiently. This includes low-level components such as compute instances, storage, and networking, as well as high-level components such as DNS entries, SaaS features, etc. Terraform can manage both existing service providers and custom in-house solutions.","source":"@site/docs/DevOps/Infra as Code/terraform.md","sourceDirName":"DevOps/Infra as Code","slug":"/DevOps/Infra as Code/terraform","permalink":"/pr-preview/pr-34/docs/DevOps/Infra as Code/terraform","draft":false,"unlisted":false,"editUrl":"https://github.com/sdelrio/golden-forest/edit/master/docs/DevOps/Infra as Code/terraform.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Ansible","permalink":"/pr-preview/pr-34/docs/DevOps/Infra as Code/ansible"},"next":{"title":"PaaS","permalink":"/pr-preview/pr-34/docs/DevOps/PaaS"}}'),s=r("85893"),t=r("50065");let a={},l="Terraform",o={},c=[{value:"ENV vars in your code",id:"env-vars-in-your-code",level:2},{value:"Lifecycle",id:"lifecycle",level:2},{value:"Code Structure",id:"code-structure",level:2},{value:"Refactoring Terraform, The Right Way",id:"refactoring-terraform-the-right-way",level:3},{value:"Tier-3 Terrafor Live environment modules",id:"tier-3-terrafor-live-environment-modules",level:4},{value:"Tier-2 Terraform Service Modules",id:"tier-2-terraform-service-modules",level:4},{value:"Tier-1 Terraform Resources Modules",id:"tier-1-terraform-resources-modules",level:4},{value:"Isolation via File layout",id:"isolation-via-file-layout",level:3},{value:"References",id:"references",level:3},{value:"Terrafrom Up &amp; Running",id:"terrafrom-up--running",level:2},{value:"Samples",id:"samples",level:3},{value:"Automation tools",id:"automation-tools",level:2},{value:"Unit Test",id:"unit-test",level:3},{value:"References",id:"references-1",level:4},{value:"Atlantis",id:"atlantis",level:3},{value:"terraform-compilance",id:"terraform-compilance",level:3},{value:"Kubestack",id:"kubestack",level:3},{value:"Ansible",id:"ansible",level:2},{value:"Produce Ansible inventory",id:"produce-ansible-inventory",level:3},{value:"References",id:"references-2",level:2}];function d(e){let n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"terraform",children:"Terraform"})}),"\n",(0,s.jsx)(n.p,{children:"Terraform is an infrastructure as code (IaC) tool that allows you to build, change, and version infrastructure safely and efficiently. This includes low-level components such as compute instances, storage, and networking, as well as high-level components such as DNS entries, SaaS features, etc. Terraform can manage both existing service providers and custom in-house solutions."}),"\n",(0,s.jsx)(n.h2,{id:"env-vars-in-your-code",children:"ENV vars in your code"}),"\n",(0,s.jsxs)(n.p,{children:["Use prefix ",(0,s.jsx)(n.code,{children:"TF_VAR_"})," in your definition:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'$ export TF_VAR_db_password="(YOUR_DB_PASSWD)"\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"vars.tf"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'(...)\nvariable "db_password" {\n  description = "the password for the database"\n  type        = string\n}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"$ terraform apply\n"})}),"\n",(0,s.jsx)(n.h2,{id:"lifecycle",children:"Lifecycle"}),"\n",(0,s.jsx)(n.p,{children:"For Elastic scale (it willl create instances before deleting them):"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"resource {\n  lifecycle {\n    create_before_destroy = ture\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"code-structure",children:"Code Structure"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://medium.com/capital-one-tech/terraform-poka-yokes-writing-effective-scalable-dynamic-and-error-resistant-terraform-dcbd6a0ada6a",children:"Writing Effective, Scalable, Dynamic, and Error-Resistant Terraform"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"refactoring-terraform-the-right-way",children:(0,s.jsx)(n.a,{href:"https://blog.doit-intl.com/refactor-terraform-into-modules-the-right-way-7bce4d57d66a",children:"Refactoring Terraform, The Right Way"})}),"\n",(0,s.jsx)(n.h4,{id:"tier-3-terrafor-live-environment-modules",children:"Tier-3 Terrafor Live environment modules"}),"\n",(0,s.jsxs)(n.p,{children:["This is the top tier\nThe ",(0,s.jsx)(n.code,{children:"terraform-live-envs"}),"is a folder containing modules implementing the infrastructure that is deployed"]}),"\n",(0,s.jsx)(n.p,{children:"These modules are usually built from the services modules but can also have resources modules mixed in"}),"\n",(0,s.jsx)(n.p,{children:"Every module attribute is a hard-coded value representing the value that is deployed"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"terraform-live-envs\n|--dev\n|    |-vpc\n|    |-mysql\n|    |-kubernetes\n|\n|--staging\n|    |-vpc\n|    |-mysql\n|    |-kubernetes\n|\n|--dev\n|    |-vpc\n|    |-mysql\n|    |-kubernetes\n|\n"})}),"\n",(0,s.jsx)(n.h4,{id:"tier-2-terraform-service-modules",children:"Tier-2 Terraform Service Modules"}),"\n",(0,s.jsx)(n.p,{children:"Service (Infrastructure type)"}),"\n",(0,s.jsxs)(n.p,{children:["This is the middle tier\n",(0,s.jsx)(n.code,{children:"terraform-services"}),"is a folder containing modules combining resources modules together from the ",(0,s.jsx)(n.code,{children:"terraform-resources"})," folder"]}),"\n",(0,s.jsxs)(n.p,{children:["Each service module is a ",(0,s.jsx)(n.em,{children:"generic service"})," that can create multiple verisons based on the variables passed in"]}),"\n",(0,s.jsx)(n.p,{children:"Example: an SQL instance module can create postgreSQL or mySQL instance"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"terraform-services (generic modules)\n|    |-gke\n|    |-vpc\n|    |-sql\n|\n"})}),"\n",(0,s.jsx)(n.h4,{id:"tier-1-terraform-resources-modules",children:"Tier-1 Terraform Resources Modules"}),"\n",(0,s.jsxs)(n.p,{children:["Complex modules from smaller, simpler modules.\n",(0,s.jsx)(n.code,{children:"terraform-resources"}),"is a folder containing modules with a single reource to be created.\nThese resource modules are creating only one ting\nThese modules should have an ",(0,s.jsx)(n.code,{children:"output.tf"}),"file with outputs values providing information on the resource created."]}),"\n",(0,s.jsx)(n.p,{children:"This info can be used to create hard dependencies between modules (required by 2nd tier)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"terraform-resources\n|    |-vpc\n|    |-sql\n|      |-instance\n|      |-user\n|\n"})}),"\n",(0,s.jsx)(n.h3,{id:"isolation-via-file-layout",children:"Isolation via File layout"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"- live\n   |- stage\n   |   |- vpc\n   |   |- services\n   |   |     \\-services\n   |   |         \\- app1  --\x3e links to modules\n   |   \\- data-storage\n   |\n   |- prod\n   |   |- vpc\n   |   |- services\n   |   |    \\-services\n   |   |        \\- app1  --\x3e links to modules\n   |   \\- data-storage\n   |\n   |- mgmt\n   |\n   |- global\n   |   |- s3\n   |   \\- iam\n   |\n   |- modules\n   |   |- vpc\n   |   |- services\n   |   |    \\-services\n   |   |        \\- app1\n   |   |            |- main.tf\n   |   |            |- variables.tf\n   |   |            \\- outputs.tf\n   |   |\n   |   \\- data-storage\n   |\n   *\n"})}),"\n",(0,s.jsx)(n.h3,{id:"references",children:"References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.slideshare.net/brikis98/lessons-learned-from-writing-over-300000-lines-of-infrastructure-code-120597849",children:"Lessons learned from writing 3000.000 lines of IaC code"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"terrafrom-up--running",children:"Terrafrom Up & Running"}),"\n",(0,s.jsx)(n.h3,{id:"samples",children:"Samples"}),"\n",(0,s.jsx)(n.p,{children:'Code samples for the book "Terraform: Up & Running" by Yevgeniy Brikman:'}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/brikis98/terraform-up-and-running-code",children:"https://github.com/brikis98/terraform-up-and-running-code"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/brikis98/terraform-up-and-running-code/tree/master/code/terraform",children:"https://github.com/brikis98/terraform-up-and-running-code/tree/master/code/terraform"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"automation-tools",children:"Automation tools"}),"\n",(0,s.jsx)(n.h3,{id:"unit-test",children:"Unit Test"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.hashicorp.com/sentinel/",children:"https://www.hashicorp.com/sentinel/"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://terratest.gruntwork.io/",children:"https://terratest.gruntwork.io/"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://serverspec.org/",children:"https://serverspec.org/"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.pulumi.com/blog/testing-your-infrastructure-as-code-with-pulumi/",children:"https://www.pulumi.com/blog/testing-your-infrastructure-as-code-with-pulumi/"})}),"\n"]}),"\n",(0,s.jsx)(n.h4,{id:"references-1",children:"References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://speakerdeck.com/jen20/terraform-without-the-mess?slide=48",children:"2020: Terraform Without the mess"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/jen20/hashidays-nyc",children:"2017: HashiDays New York 2017"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.contino.io/insights/top-3-terraform-testing-strategies-for-ultra-reliable-infrastructure-as-code",children:"2017: Top 3 Terraform Testing Strategies for Ultra-Reliable Infrastructure-as-Code"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"atlantis",children:"Atlantis"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://www.runatlantis.io/",children:"Atlantis"})," is a Terraform Pull Request Automation."]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Open a Terrafrom Pull Request."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Atlantis automatically runs ",(0,s.jsx)(n.code,{children:"terraform plan"})," and comments back on the pull request."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Then, someone reviews the plan and approves the PR."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["You comment ",(0,s.jsx)(n.code,{children:"atlantis apply"})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Atlantis runs ",(0,s.jsx)(n.code,{children:"terraform apply"})," and comments back the pull request."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Merge the pull request."}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"terraform-compilance",children:"terraform-compilance"}),"\n",(0,s.jsx)(n.p,{children:"Compilance as Code."}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"terraform-compliance"})," is a lightweight, security and compliance focused test framework against terraform to enable negative testing capability for your infrastructure-as-code."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://terraform-compliance.com/",children:"Homepage"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/terraform-compliance/cli",children:"GitHub"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.slideshare.net/EmreErkunt/compliance-as-code-with-terraformcompliance",children:"SlideShare presentation"})}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"kubestack",children:"Kubestack"}),"\n",(0,s.jsx)(n.p,{children:"Free and Open Source GitOps framework to codify your custom platform stack using Terraform."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.kubestack.com/",children:"Homepage"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"ansible",children:"Ansible"}),"\n",(0,s.jsx)(n.h3,{id:"produce-ansible-inventory",children:"Produce Ansible inventory"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Create instances."}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"instances.tf"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-hlc",children:'### The bastionresource\n"aws_instance" "bastion" {\n  ami = var.ami\n  availability_zone = var.az\n  instance_type = "t2.micro"\n  key_name = var.ssh-key\n  vpc_security_group_ids = [aws_default_security_group.sg-public.id]\n  subnet_id = aws_subnet.public.id\n  tags = {\n    Name = "Bastion"\n    Projet = var.projet\n    Application = var.Application\n  }\n  volume_tags = {\n    Name = "Bastion"\n    Projet = var.projet\n    Application = var.Application\n  }\n  root_block_device {   volume_size = 8  }}\n\n  ### The Elastic IP for the Bastion\n  resource "aws_eip" "eip-bastion" {\n    vpc = true\n    instance = aws_instance.bastion.id\n    associate_with_private_ip = aws_instance.bastion.private_ip\n    tags = {\n      Name = "bastion"\n      Projet = var.projet\n      Application = var.Application\n    }\n  }\n\n  ### The private instances\n  resource "aws_instance" "i-private" {\n    ami = var.ami\n    availability_zone = var.az\n    instance_type = var.ec2_type\n    key_name = var.ssh-key\n    vpc_security_group_ids = [aws_security_group.sg-private.id]\n    subnet_id = aws_subnet.private.id\n    tags = {\n      Name = "i-private"\n      Projet = var.projet\n      Application = var.Application\n    }\n    volume_tags = {\n      Name = "i-private"\n      Projet = var.projet\n      Application = var.Application\n    }\n    root_block_device {\n      volume_size = 8\n    }\n    ebs_block_device {\n      device_name = "/dev/sdb"\n      volume_type = var.ebs_type\n      volume_size = 8\n    }\n    count = var.ec2_nb\n  }\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["Output the information using resource type ",(0,s.jsx)(n.code,{children:"local_file"})," with a filename attribute set to ",(0,s.jsx)(n.code,{children:"inventory"}),". It's attribute ",(0,s.jsx)(n.code,{children:"content"})," is the return of the ",(0,s.jsx)(n.code,{children:"templatefile"})," function"]}),"\n"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"outputs.tf"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'### The Ansible inventory file\nresource "local_file" "AnsibleInventory" {\n  content = templatefile("inventory.tmpl", {\n    bastion-dns = aws_eip.eip-bastion.public_dns,\n    bastion-ip = aws_eip.eip-bastion.public_ip,\n    bastion-id = aws_instance.bastion.id,\n    private-dns = aws_instance.i-private.*.private_dns,\n    private-ip = aws_instance.i-private.*.private_ip,\n    private-id = aws_instance.i-private.*.id\n  })\n  filename = "inventory"\n}\n'})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"The template."}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"[bastion]\n${bastion-dns} ansible_host=${bastion-ip} # ${bastion-id}\n[servers]\n%{ for index, dns in private-dns ~}\n${dns} ansible_host=${private-ip[index]} # ${private-id[index]}\n%{ endfor ~}\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"4",children:["\n",(0,s.jsx)(n.li,{children:"Result"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"[bastion]\nec2-99-79-28-17.ca-central-1.compute.amazonaws.com ansible_host=99.79.28.17 # i-0d8c4197a22797\n\n[servers]\nip-10-1-2-114.ca-central-1.compute.internal ansible_host=10.1.2.114 # i-09752396073622ba6\nip-10-1-2-251.ca-central-1.compute.internal ansible_host=10.1.2.251 # i-0af7dddbe098fb1c9\nip-10-1-2-35.ca-central-1.compute.internal ansible_host=10.1.2.35 # i-0de0126836e547eba\nip-10-1-2-109.ca-central-1.compute.internal ansible_host=10.1.2.109 # i-060a362c0165ab3f2\nip-10-1-2-185.ca-central-1.compute.internal ansible_host=10.1.2.185 # i-07bd962925faafa3b\nip-10-1-2-93.ca-central-1.compute.internal ansible_host=10.1.2.93 # i-0fc357d17b62b1497\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"5",children:["\n",(0,s.jsx)(n.li,{children:"Provisioner"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"$ cat <<ENDL > playbook.yml\n---\n- hosts: all\nbecome: yes\nbecome_user: root\nbecome_method: sudo\ntasks:\n- name: Install nginx\napt:\nname: nginx\nstate: latest\n- name: Restart Nginx\nservice: name=nginx state=restarted\nbecome: yes\nENDL\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'provisioner "local-exec" {\n  command = "sleep 120; ansible-playbook -i \'${digitalocean_droplet.www-example.ipv4_address}\' playbook.yml"\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.linkbynet.com/en/news/produce-an-ansible-inventory-with-terraform",children:"https://www.linkbynet.com/en/news/produce-an-ansible-inventory-with-terraform"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://alexharv074.github.io/2019/11/23/adventures-in-the-terraform-dsl-part-x-templates.html#example-4-if-else-endif-example",children:"https://alexharv074.github.io/2019/11/23/adventures-in-the-terraform-dsl-part-x-templates.html#example-4-if-else-endif-example"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.splunk.com/en_us/blog/devops/writing-ansible-playbooks-for-new-terraform-servers.html",children:"https://www.splunk.com/en_us/blog/devops/writing-ansible-playbooks-for-new-terraform-servers.html"})}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"references-2",children:"References"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.terraform.io/intro",children:"Homepage"})}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},50065:function(e,n,r){r.d(n,{Z:function(){return l},a:function(){return a}});var i=r(67294);let s={},t=i.createContext(s);function a(e){let n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);